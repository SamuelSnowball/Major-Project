<!DOCTYPE HTML>

<head>
	<title>Mars Scene in WebGL</title>
	<link rel="stylesheet" href="code/css/gui.css">
	<link rel="stylesheet" href="libraries/jquery-ui-1.12.1.custom/jquery-ui.css">
	<script src="libraries/jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
	<script src="libraries/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
</head>

<body>

<link rel="stylesheet" href="code/css/gui.css">

<div id="banner"><p>Mars Scene in WebGL</p></div>
<div>fps: <span id="fps"></span></div>

<!-- GL Canvas -->
<canvas id="canvas" class="canvasClass"></canvas>

<div id="outOfBoundsID" style="visibility: hidden">ALERT - Terrain too dangerous!</div>

<!-- Menu at top left -->
<ul id="menu" style="visibility: hidden">
	<li>
		<div>Menu</div> <!-- Once clicked others should show -->
		<ul>
			<li><div>Help</div>
				<ul>
					<li><div>Press P to prospect</div></li>
				</ul>
			</li>
			<li><div>Sound</div></li>
			<li><div>Controls</div>
				<ul>
					<li><div>Invert controls</div></li>
				</ul>		
			</li>
			<li><div>About</div></li>
		</ul>
	</li>	
</ul>
<!-- End Menu -->

<!-- Libraries -->
<script src="libraries/m4.js"></script>
<script src="libraries/ImprovedNoise.js"></script>
<script src="libraries/webgl-obj-loader.js"></script>
<script src="libraries/twgl-full.min.js"></script>

<!-- WebGL setup files including shaders and program -->
<script src="code/myJs/GLSetup.js"></script>
<script src="code/myJs/TextureLoader.js"></script>
<script src="code/myJs/VertexShader.js"></script>
<script src="code/myJs/FragmentShader.js"></script>
<script src="code/myJs/Program.js"></script>

<!-- Game files -->
<script src="code/myJs/CollisionTester.js"></script>
<script src="code/myJs/Terrain.js"></script>
<script src="code/myJs/RockGenerator.js"></script>
<script src="code/myJs/GUI.js"></script>
<script src="code/myJs/LoadingScreen.js"></script>
<script src="code/myJs/ParticleSystem.js"></script>
<script src="code/myJs/WaterSystem.js"></script>
<script src="code/myJs/Sound.js"></script>
<script src="code/myJs/Lander.js"></script>
<script src="code/myJs/Utility.js"></script>
<script src="code/myJs/Skybox.js"></script>
<script src="code/myJs/WaterFrameBuffer.js"></script>
<script src="code/myJs/Camera.js"></script>
<script src="code/myJs/PointerLockControls.js"></script>

<script>

var gameRunning = false;
var perlin = new ImprovedNoise();

var utility = new Utility();
var controls = new PointerLockControls();
var camera = new Camera();

var textureLoader = new TextureLoader();
var loadingScreen = new LoadingScreen();

var terrain = new Terrain();
var rockGenerator = new RockGenerator();

var collisionTester = new CollisionTester();
var particleSystem = new ParticleSystem();

var sound = new Sound();
var lander = new Lander();
var gui = new GUI();
var skybox = new Skybox();

var waterFrameBuffers = new WaterFrameBuffer();
var waterSystem = new WaterSystem();

// Taken
var fpsElement = document.getElementById("fps");
var then = Date.now() / 1000;  // get time in seconds
var cameraMatrix = m4.identity();








var squareVertexPositionBuffer = gl.createBuffer();;
    gl.bindBuffer(gl.ARRAY_BUFFER, squareVertexPositionBuffer);
var vertices = [
         1.0,  1.0,  0.0,
        -1.0,  1.0,  0.0,
         1.0, -1.0,  0.0,
        -1.0, -1.0,  0.0
    ];
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
	gl.vertexAttribPointer(positionAttribLocation, 3, gl.FLOAT, false, 0, 0);
	
var	squareUVBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, squareUVBuffer);
var	uvs = [
		0,0,
		0,1,
		1,0,
		1,1
	];
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(uvs), gl.STATIC_DRAW);
    gl.vertexAttribPointer(textureCoordLocation, 2, gl.FLOAT, false, 0, 0);
	
function renderReflectionGUI(){
	
	gl.enableVertexAttribArray(positionAttribLocation);
	gl.enableVertexAttribArray(textureCoordLocation);
	
	scale = m4.scaling(10, 10, 10);
	rotateX = m4.xRotation(0);
	rotateY = m4.yRotation(0);
	rotateZ = m4.zRotation(Math.PI / 2); //-Math.PI / 2
	position = m4.translation(250, 15, 250);
	gl.activeTexture(gl.TEXTURE0);
	gl.bindTexture(gl.TEXTURE_2D, reflectionTexture);
	gl.uniform1i(gl.getUniformLocation(program, "uSampler"), 0);
	
	updateAttributesAndUniforms();
	
	
	gl.bindBuffer(gl.ARRAY_BUFFER, squareVertexPositionBuffer);
    gl.vertexAttribPointer(positionAttribLocation,3, gl.FLOAT, false, 0, 0);
	
	gl.bindBuffer(gl.ARRAY_BUFFER, squareUVBuffer);
    gl.vertexAttribPointer(textureCoordLocation, 2, gl.FLOAT, false, 0, 0);
	
	gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
	
	
}
var squareVertexPositionBuffer2 = gl.createBuffer();;
    gl.bindBuffer(gl.ARRAY_BUFFER, squareVertexPositionBuffer2);
var vertices2 = [
         1.0,  1.0,  0.0,
        -1.0,  1.0,  0.0,
         1.0, -1.0,  0.0,
        -1.0, -1.0,  0.0
    ];
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices2), gl.STATIC_DRAW);
	gl.vertexAttribPointer(positionAttribLocation, 3, gl.FLOAT, false, 0, 0);
	
var	squareUVBuffer2 = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, squareUVBuffer2);
var	uvs2 = [
		0,0,
		0,1,
		1,0,
		1,1
	];
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(uvs2), gl.STATIC_DRAW);
    gl.vertexAttribPointer(textureCoordLocation, 2, gl.FLOAT, false, 0, 0);
function renderRefractionGUI(){
	
	gl.enableVertexAttribArray(positionAttribLocation);
	gl.enableVertexAttribArray(textureCoordLocation);
	
	scale = m4.scaling(10, 10, 10);
	rotateX = m4.xRotation(0);
	rotateY = m4.yRotation(0);
	rotateZ = m4.zRotation(Math.PI / 2); //-Math.PI / 2
	position = m4.translation(275, 15, 250);
	gl.activeTexture(gl.TEXTURE0);
	gl.bindTexture(gl.TEXTURE_2D, refractionTexture);
	gl.uniform1i(gl.getUniformLocation(program, "uSampler"), 0);
	
	updateAttributesAndUniforms();
	
	
	gl.bindBuffer(gl.ARRAY_BUFFER, squareVertexPositionBuffer2);
    gl.vertexAttribPointer(positionAttribLocation,3, gl.FLOAT, false, 0, 0);
	
	gl.bindBuffer(gl.ARRAY_BUFFER, squareUVBuffer2);
    gl.vertexAttribPointer(textureCoordLocation, 2, gl.FLOAT, false, 0, 0);
	
	gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

	
}










function render(){
	var now = Date.now() / 1000;  // get time in seconds
    var elapsedTime = now - then;
    then = now;
	var fps = 1 / elapsedTime;
    fpsElement.innerText = fps.toFixed(0); 
		
	camera.assignCameraQuadrant();

	// Render the entire scene to each the reflection and refraction textures
	// (2x FULL scene render calls)
	waterSystem.renderToReflectionBuffer();
	waterSystem.renderToRefractionBuffer();
	
	/*
	Now render the scene as usual
	We've already switched back to the default frame buffer
	*/
	gl.clearColor(0.8, 0.8, 0.8, 0.7);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	// Cant disable clipPlane on some drivers, just set to 0
	clipPlane = [0, 0, 0, 0];
	
	camera.updateCamera();
	
	/*
	Don't change render order
	terrain render generates the renderIndices, 
	that are needed for rock rendering
	*/
	terrain.render(); 
	rockGenerator.renderInstancedRocks();
	particleSystem.render(); 
	collisionTester.testAllCollision();
	lander.render();
	waterSystem.render();

	
	
	//skybox.render(viewMatrix, projectionMatrix);
	
	//renderRefractionGUI();
	//renderReflectionGUI();

	
	requestAnimationFrame(render);
}

/*
This gets called when the user clicks to start the game
*/
function setup(){
	gameRunning = true;
	clearInterval(loadingScreen.animateBackground); //LoadingScreen.js

	// Show GUIs
	gui.showElements();	

	render();
}

</script>


</body>
</html>