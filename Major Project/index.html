<!DOCTYPE HTML>

<head>
	<title>Mars Scene in WebGL</title>
	<link rel="stylesheet" href="code/css/gui.css">
	<link rel="stylesheet" href="libraries/jquery-ui-1.12.1.custom/jquery-ui.css">
	<script src="libraries/jquery-ui-1.12.1.custom/external/jquery/jquery.js"></script>
	<script src="libraries/jquery-ui-1.12.1.custom/jquery-ui.js"></script>
</head>


<body>

<link rel="stylesheet" href="code/css/gui.css">

<div id="banner"><p>Mars Scene in WebGL</p></div>
<div>fps: <span id="fps"></span></div>

<!-- GL Canvas -->
<canvas id="canvas" class="canvasClass"></canvas>

<div id="outOfBoundsID" style="visibility: hidden">ALERT - Terrain too dangerous!</div>

<!-- Menu at top left -->
<ul id="menu" style="visibility: hidden">
	<li>
		<div>Menu</div> <!-- Once clicked others should show -->
		<ul>
			<li><div>Help</div>
				<ul>
					<li><div>Press P to prospect</div></li>
				</ul>
			</li>
			<li><div>Sound</div></li>
			<li><div>Controls</div>
				<ul>
					<li><div>Invert controls</div></li>
				</ul>		
			</li>
			<li><div>About</div></li>
		</ul>
	</li>	
</ul>
<!-- End Menu -->

<!-- Libraries -->
<script src="libraries/m4.js"></script>
<script src="libraries/ImprovedNoise.js"></script>

<script src="libraries/webgl-obj-loader.js"></script>

<script src="https://twgljs.org/dist/2.x/twgl-full.min.js"></script>


<!-- WebGL setup files including shaders and program -->
<script src="code/myJs/GLSetup.js"></script>
<script src="code/myJs/TextureLoader.js"></script>
<script src="code/myJs/VertexShader.js"></script>
<script src="code/myJs/FragmentShader.js"></script>
<script src="code/myJs/Program.js"></script>

<!-- Game files -->
<script src="code/myJs/CollisionTester.js"></script>
<script src="code/myJs/Terrain.js"></script>
<script src="code/myJs/RockGenerator.js"></script>
<script src="code/myJs/GUI.js"></script>
<script src="code/myJs/LoadingScreen.js"></script>
<script src="code/myJs/ParticleSystem.js"></script>
<script src="code/myJs/WaterSystem.js"></script>
<script src="code/myJs/Player.js"></script>
<script src="code/myJs/Sound.js"></script>
<script src="code/myJs/Lander.js"></script>
<script src="code/myJs/Utility.js"></script>
<script src="code/myJs/WorldState.js"></script>

<!-- Needs OO? -->
<script src="code/myJs/Mouse.js"></script>

<script>

var gameRunning = false;
var perlin = new ImprovedNoise();

var textureLoader = new TextureLoader();
var utility = new Utility();
var loadingScreen = new LoadingScreen();

var terrain = new Terrain();
var rockGenerator = new RockGenerator();

var worldState = new WorldState(); //Loads and saves the world
var collisionTester = new CollisionTester();
var particleSystem = new ParticleSystem();
var waterSystem = new WaterSystem();
var sound = new Sound();
var lander = new Lander();
var player = new Player(315, 1, 315); 
var gui = new GUI();

//For saving the game
var gameTime = 0;
var saveTime = 100;

//Taken
var fpsElement = document.getElementById("fps");
var then = Date.now() / 1000;  // get time in seconds

function render(){
	var now = Date.now() / 1000;  // get time in seconds
    var elapsedTime = now - then;
    then = now;
	var fps = 1 / elapsedTime;
    fpsElement.innerText = fps.toFixed(0); 

	gl.clearColor(0.8, 0.8, 0.8, 0.7);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	
	/*
	Auto-save the game every 20 seconds or so
	But only save if they're not in minimap mode
	Otherwise their Y position gets saved at 500
	*/
	if(gameTime === saveTime){
		if(useFog === true){
			console.log("World auto saved");
			worldState.saveWorld();
			gameTime = 0;
		}
	}
	//console.log("Player X, Y, Z: " + Math.floor(player.get.x) + ", " + Math.floor(player.get.y) + ", " + Math.floor(player.get.z));
	
	player.movePlayer();
	player.assignPlayerQuadrant();

	// Don't change render order
	// terrain render generates the renderIndices, 
	// that are needed for rock rendering
	terrain.render(); 
	rockGenerator.renderInstancedRocks();
	
	particleSystem.render(); 
	
	

	collisionTester.testAllCollision();

	//rockGenerator.renderObjRocks();
	

	waterSystem.updateWaterVertices();
	waterSystem.render();
	
	lander.render();
	
	gameTime++;
	requestAnimationFrame(render);
}





/*
This gets called when the user clicks to start the game
*/
function setup(){
	gameRunning = true;
	clearInterval(loadingScreen.animateBackground); //LoadingScreen.js

	// Show GUIs
	gui.showElements();	
	
	// Load player data if it exists
	// worldState.loadWorld();
	
	render();
}

</script>


</body>
</html>