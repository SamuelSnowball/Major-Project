<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Skybox.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Camera.html">Camera</a></li>
                                <li><a href="../classes/CollisionTester.html">CollisionTester</a></li>
                                <li><a href="../classes/MarsScene.html">MarsScene</a></li>
                                <li><a href="../classes/Minimap.html">Minimap</a></li>
                                <li><a href="../classes/MyGUI.html">MyGUI</a></li>
                                <li><a href="../classes/ParticleSystem.html">ParticleSystem</a></li>
                                <li><a href="../classes/PointerLockControls.html">PointerLockControls</a></li>
                                <li><a href="../classes/RockGenerator.html">RockGenerator</a></li>
                                <li><a href="../classes/Skybox.html">Skybox</a></li>
                                <li><a href="../classes/Terrain.html">Terrain</a></li>
                                <li><a href="../classes/Texture.html">Texture</a></li>
                                <li><a href="../classes/TextureLoader.html">TextureLoader</a></li>
                                <li><a href="../classes/Utility.html">Utility</a></li>
                                <li><a href="../classes/WaterSystem.html">WaterSystem</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Engine.html">Engine</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: Skybox.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">

/**
 * Has the skybox render method
 * Alas this file creates the day/night cycle
 * 
 * @class Skybox
*/
function Skybox(){
	
	var rotationSpeed = 1; // 1 degree per frame
	var currentRotation = 0;
	var blendFactor = 0; // for blending of the 2 skybox textures
	var time = 0; // time of day
	var timeIncrement = 0.001;
	
	var skyColourIncrement = 0.001; // how quickly the fog increases/decreases based on time of day
	
	this.get = {
		/**
		@method get.currentRotation
		@public
		@return {float} the cameras current rotation
		*/
		get currentRotation(){
			return currentRotation;
		},
		/**
		@method get.currentTime
		@public
		@return {float} the current time of the world (0000 -&gt; 2400)
		*/		
		get currentTime(){
			return time;
		}
	};
	
	var skyboxVertexShader = gl.createShader(gl.VERTEX_SHADER);
	gl.shaderSource(skyboxVertexShader, [
		&#x27;attribute vec3 skyboxPosition;&#x27;,
		&#x27;varying vec3 skyboxTextureCoords;&#x27;,

		&#x27;uniform mat4 projectionMatrix;&#x27;,
		&#x27;uniform mat4 viewMatrix;&#x27;,
		
		// Don&#x27;t want to apply translation to the skybox,
		// Keep it at the max clip space coordinates
		// But want to keep the rotation
		&#x27;void main(void){&#x27;,
			&#x27;gl_Position = projectionMatrix * viewMatrix * vec4(skyboxPosition, 1.0); &#x27;,
			&#x27;skyboxTextureCoords = skyboxPosition;&#x27;,
		&#x27;}&#x27;
		
	].join(&#x27;\n&#x27;));
	gl.compileShader(skyboxVertexShader);
	console.log(&quot;Skybox vertex shader compliation status: &quot; + gl.getShaderInfoLog(skyboxVertexShader));
	
	var skyboxFragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
	gl.shaderSource(skyboxFragmentShader, [
		&#x27;precision highp float;&#x27;,
		
		&#x27;varying vec3 skyboxTextureCoords;&#x27;,

		&#x27;uniform samplerCube cubeMap;&#x27;,
		&#x27;uniform samplerCube cubeMap2;&#x27;, // for night
		&#x27;uniform float blendFactor;&#x27;, // how much of each skybox texture to render
		// 0 = just render first texture, 1 = just second 

		&#x27;vec3 texture(samplerCube sampler, vec3 c){&#x27;,
			&#x27;return textureCube(sampler, c).rgb;&#x27;,
		&#x27;}&#x27;,
		
		// blends skybox with fog colour
		&#x27;uniform vec4 skyColour;&#x27;,
		&#x27;float lowerLimit = 0.0;&#x27;,
		&#x27;float upperLimit = 20.0;&#x27;,
		
		&#x27;void main(void){&#x27;,
			&#x27;vec3 sample = texture(cubeMap, skyboxTextureCoords);&#x27;,
			&#x27;vec3 sample2 = texture(cubeMap2, skyboxTextureCoords);&#x27;,
			&#x27;vec3 finalSkyboxMixColour = mix(sample, sample2, blendFactor);&#x27;,
			
			&#x27;float factor = (skyboxTextureCoords.y - lowerLimit) / (upperLimit - lowerLimit);&#x27;,
			&#x27;factor = clamp(factor, 0.0, 1.0);&#x27;,
			
			&#x27;gl_FragColor = mix(skyColour, vec4(finalSkyboxMixColour, 1.0), factor);&#x27;,
		&#x27;}&#x27;
		
	].join(&#x27;\n&#x27;));
	gl.compileShader(skyboxFragmentShader);
	console.log(&quot;Skybox fragment shader compliation status: &quot; + gl.getShaderInfoLog(skyboxFragmentShader));
	
	var skyboxProgram = gl.createProgram();
	gl.attachShader(skyboxProgram, skyboxVertexShader);
	gl.attachShader(skyboxProgram, skyboxFragmentShader);
	gl.linkProgram(skyboxProgram);
	console.log(&quot;skyboxProgram status: &quot; + gl.getProgramInfoLog(skyboxProgram));
	gl.useProgram(skyboxProgram); //allowed to be here? or at bottom

	/*
	Attribute locations in new shaders
	*/
	gl.useProgram(skyboxProgram);
		var skyboxPositionAttribLocation = gl.getAttribLocation(skyboxProgram, &#x27;skyboxPosition&#x27;);
		gl.enableVertexAttribArray(skyboxPositionAttribLocation);
		
		var skyboxViewMatrixLocation = gl.getUniformLocation(skyboxProgram, &#x27;viewMatrix&#x27;);
		gl.uniformMatrix4fv(skyboxViewMatrixLocation, false, new Float32Array(viewMatrix));
		
		var skyboxProjectionLocation = gl.getUniformLocation(skyboxProgram, &#x27;projectionMatrix&#x27;);
		gl.uniformMatrix4fv(skyboxProjectionLocation, false, new Float32Array(projectionMatrix));
		
		var skyboxFogColourLocation = gl.getUniformLocation(skyboxProgram, &#x27;skyColour&#x27;);
		gl.enableVertexAttribArray(skyboxFogColourLocation);
		
		// Skybox blending uniforms
		var skyboxBlendFactorLocation = gl.getUniformLocation(skyboxProgram, &#x27;blendFactor&#x27;);
		
	gl.useProgram(program);
	
	/**
	This function:
		Updates the time of day,
		Updates the skybox from night to day etc
		Changes fog colour based on time of day
		Sets the water reflectivity based on time of day (at night, no specular highlights)
	
	@method updateDay
	@private
	*/
	function updateDay(){
		
		// 0.00000000000003 bit slow
		// 0.0000000000003 bit fast
		time += Date.now()*0.0000000000001; // 4 is too fast
		
		if(time &gt; 2400){
			time = 0;
		}
		
		/*
		Base the blend factor on time of day
			blendFactor = 1, fully night
			blendFactor = 0, fully day
	
		Fog/Sky colours:
			White [1, 1, 1, 1]
			Black [0, 0, 0, 1]

		Set waterReflectivity based on time of day
		*/
		var waterReflectivityIncrement = waterSystem.get.waterReflectivityIncrement;
		
		if(time &gt; 1800 &amp;&amp; time &lt; 2400){
			// Start blending to night (1)
			blendFactor += timeIncrement;
			if(blendFactor &gt; 1){
				blendFactor = 1;
			}
			// Make fog darker
			skyColour[0] -= skyColourIncrement;
			skyColour[1] -= skyColourIncrement;
			skyColour[2] -= skyColourIncrement;
			
			if(skyColour[0] &lt; 0 || skyColour[1] &lt; 0 || skyColour[2] &lt; 0){
				skyColour[0] = 0;
				skyColour[1] = 0;
				skyColour[2] = 0;
			}
			
			// Decrease waterReflectivity, then stop it going below 0
			waterSystem.set.waterReflectivity = waterSystem.get.waterReflectivity - waterReflectivityIncrement;
			if(waterSystem.get.waterReflectivity &lt; 0){
				waterSystem.set.waterReflectivity = 0;
			}
		}
		else if(time &gt; 0 &amp;&amp; time &lt; 0600){
			// Keep at night (1)
			blendFactor = 1;
			// Keep fog black
			skyColour[0] = 0;
			skyColour[1] = 0;
			skyColour[2] = 0;
			
			waterSystem.set.waterReflectivity = 0;
		}
		else if(time &gt; 0600 &amp;&amp; time &lt; 1200){
			// Start blending to day (0)
			blendFactor -= timeIncrement;
			if(blendFactor &lt; 0){
				blendFactor = 0;
			}
			// Blend fog to white
			skyColour[0] += skyColourIncrement;
			skyColour[1] += skyColourIncrement;
			skyColour[2] += skyColourIncrement;
			
			if(skyColour[0] &gt; 1 || skyColour[1] &gt; 1 || skyColour[2] &gt; 1){
				skyColour[0] = 1;
				skyColour[1] = 1;
				skyColour[2] = 1;
			}
			
			// Increase waterReflectivity, stop it going over 1
			waterSystem.set.waterReflectivity = waterSystem.get.waterReflectivity + waterReflectivityIncrement;
			if(waterSystem.get.waterReflectivity &gt; 1){
				waterSystem.set.waterReflectivity = 1;
			}
		}
		else if(time &gt; 1200 &amp;&amp; time &lt; 1800){
			// Keep at day (0) 
			blendFactor = 0;
			// Keep fog white
			skyColour[0] = 1;
			skyColour[1] = 1;
			skyColour[2] = 1;
			
			// Keep waterReflectivity at its maximum value
			waterSystem.set.waterReflectivity = 1;
		}
	}
	
	gl.useProgram(skyboxProgram);
	var SIZE = 256;
	var skybox_vertices_buffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, skybox_vertices_buffer);
	var skybox_vertices = [        
	    -SIZE,  SIZE, -SIZE,
	    -SIZE, -SIZE, -SIZE,
	    SIZE, -SIZE, -SIZE,
	     SIZE, -SIZE, -SIZE,
	     SIZE,  SIZE, -SIZE,
	    -SIZE,  SIZE, -SIZE,

	    -SIZE, -SIZE,  SIZE,
	    -SIZE, -SIZE, -SIZE,
	    -SIZE,  SIZE, -SIZE,
	    -SIZE,  SIZE, -SIZE,
	    -SIZE,  SIZE,  SIZE,
	    -SIZE, -SIZE,  SIZE,

	     SIZE, -SIZE, -SIZE,
	     SIZE, -SIZE,  SIZE,
	     SIZE,  SIZE,  SIZE,
	     SIZE,  SIZE,  SIZE,
	     SIZE,  SIZE, -SIZE,
	     SIZE, -SIZE, -SIZE,

	    -SIZE, -SIZE,  SIZE,
	    -SIZE,  SIZE,  SIZE,
	     SIZE,  SIZE,  SIZE,
	     SIZE,  SIZE,  SIZE,
	     SIZE, -SIZE,  SIZE,
	    -SIZE, -SIZE,  SIZE,

	    -SIZE,  SIZE, -SIZE,
	     SIZE,  SIZE, -SIZE,
	     SIZE,  SIZE,  SIZE,
	     SIZE,  SIZE,  SIZE,
	    -SIZE,  SIZE,  SIZE,
	    -SIZE,  SIZE, -SIZE,

	    -SIZE, -SIZE, -SIZE,
	    -SIZE, -SIZE,  SIZE,
	     SIZE, -SIZE, -SIZE,
	     SIZE, -SIZE, -SIZE,
	    -SIZE, -SIZE,  SIZE,
	     SIZE, -SIZE,  SIZE
	];
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(skybox_vertices), gl.STATIC_DRAW);
	gl.vertexAttribPointer(skyboxPositionAttribLocation, 3, gl.FLOAT, false, 0, 0);
	gl.useProgram(program);
	
	/**
	This function loads the skybox variables into the shader
	It also rotates the skybox
	
	@method updateSkyboxAttributesAndUniforms
	@private
	*/
	function updateSkyboxAttributesAndUniforms( ){
		// Remove the translation from the view matrix
		// So the skybox doesn&#x27;t move in relation to the camera
		// Stays at max clip space coordinates
		viewMatrix[12] = 0;
		viewMatrix[13] = 0;
		viewMatrix[14] = 0;

		// Increase skybox rotation
		currentRotation += rotationSpeed * Date.now() * 0.00000000000000009;
		
		// Rotate viewMatrix by angle, and store in viewMatrix
		m4.yRotate(viewMatrix, currentRotation, viewMatrix);
		
		// Load blend factor, waterReflectivity, skyColour
		updateDay();
		
		gl.uniform1f(skyboxBlendFactorLocation, blendFactor);
		
		gl.uniform4fv(skyboxFogColourLocation, skyColour);
		gl.uniformMatrix4fv(skyboxViewMatrixLocation, false, new Float32Array(viewMatrix));
		gl.uniformMatrix4fv(skyboxProjectionLocation, false, new Float32Array(projectionMatrix));
	}
	
	/**
	Renders the skybox
	
	@method render
	@public
	*/
	this.render = function(){
		gl.useProgram(skyboxProgram);
		
		// Reset matrices
		scale = m4.scaling(1, 1, 1);
		rotateX = m4.xRotation(0);
		rotateY = m4.yRotation(0);
		rotateZ = m4.zRotation(0);
		position = m4.translation(0, 0, 0);

		// Times matrices together
		updateSkyboxAttributesAndUniforms();

		// CubeMap1 Sample from unit 0
		gl.activeTexture(gl.TEXTURE0);
		gl.uniform1i(gl.getUniformLocation(skyboxProgram, &quot;cubeMap&quot;), 0);
		gl.bindTexture(gl.TEXTURE_CUBE_MAP, skybox_texture);
		
		// CubeMap2 Sample from unit 1
		gl.activeTexture(gl.TEXTURE1);
		gl.uniform1i(gl.getUniformLocation(skyboxProgram, &quot;cubeMap2&quot;), 1);
		gl.bindTexture(gl.TEXTURE_CUBE_MAP, skybox_night_texture);
		
		gl.bindBuffer(gl.ARRAY_BUFFER, skybox_vertices_buffer);
		gl.vertexAttribPointer(skyboxPositionAttribLocation, 3, gl.FLOAT, false, 0, 0);
		
		gl.drawArrays(gl.TRIANGLES, 0, skybox_vertices.length/3);
		
		gl.useProgram(program);
	}
	
}
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
